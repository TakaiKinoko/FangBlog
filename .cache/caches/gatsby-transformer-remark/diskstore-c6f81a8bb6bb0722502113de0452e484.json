{"expireTime":9007200830667733000,"key":"transformer-remark-markdown-ast-88d1f330f96ba2d1b3e773d15c176061-gatsby-remark-imagesgatsby-remark-responsive-iframegatsby-remark-prismjsgatsby-remark-copy-linked-filesgatsby-remark-smartypantsgatsby-remark-reading-time-","val":{"type":"root","children":[{"type":"paragraph","children":[{"type":"text","value":"Motivated by a CUDA puzzle I tried to solve today, I’d like to talk more about resource assignment. ","position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":2,"column":101,"offset":101},"indent":[]}}],"position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":2,"column":101,"offset":101},"indent":[]}},{"type":"heading","depth":2,"children":[{"type":"text","value":"A Puzzle","position":{"start":{"line":4,"column":4,"offset":106},"end":{"line":4,"column":12,"offset":114},"indent":[]}}],"position":{"start":{"line":4,"column":1,"offset":103},"end":{"line":4,"column":12,"offset":114},"indent":[]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"problem","position":{"start":{"line":6,"column":5,"offset":120},"end":{"line":6,"column":12,"offset":127},"indent":[]}}],"position":{"start":{"line":6,"column":1,"offset":116},"end":{"line":6,"column":12,"offset":127},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"Adding two big arrays element-wise.","position":{"start":{"line":8,"column":1,"offset":129},"end":{"line":8,"column":36,"offset":164},"indent":[]}}],"position":{"start":{"line":8,"column":1,"offset":129},"end":{"line":8,"column":36,"offset":164},"indent":[]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"settings","position":{"start":{"line":10,"column":5,"offset":170},"end":{"line":10,"column":13,"offset":178},"indent":[]}}],"position":{"start":{"line":10,"column":1,"offset":166},"end":{"line":10,"column":13,"offset":178},"indent":[]}},{"type":"list","ordered":false,"start":null,"spread":false,"children":[{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"Suppose a GPU has 8 SMs","position":{"start":{"line":12,"column":3,"offset":182},"end":{"line":12,"column":26,"offset":205},"indent":[]}}],"position":{"start":{"line":12,"column":3,"offset":182},"end":{"line":12,"column":26,"offset":205},"indent":[]}}],"position":{"start":{"line":12,"column":1,"offset":180},"end":{"line":12,"column":26,"offset":205},"indent":[]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"Each SM has 32 SPs","position":{"start":{"line":13,"column":3,"offset":208},"end":{"line":13,"column":21,"offset":226},"indent":[]}}],"position":{"start":{"line":13,"column":3,"offset":208},"end":{"line":13,"column":21,"offset":226},"indent":[]}}],"position":{"start":{"line":13,"column":1,"offset":206},"end":{"line":13,"column":21,"offset":226},"indent":[]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"Warp size is 16, instead of 32","position":{"start":{"line":14,"column":3,"offset":229},"end":{"line":14,"column":33,"offset":259},"indent":[]}}],"position":{"start":{"line":14,"column":3,"offset":229},"end":{"line":14,"column":33,"offset":259},"indent":[]}}],"position":{"start":{"line":14,"column":1,"offset":227},"end":{"line":14,"column":33,"offset":259},"indent":[]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"kernel adds one element from each array together","position":{"start":{"line":15,"column":3,"offset":262},"end":{"line":15,"column":51,"offset":310},"indent":[]}}],"position":{"start":{"line":15,"column":3,"offset":262},"end":{"line":15,"column":51,"offset":310},"indent":[]}}],"position":{"start":{"line":15,"column":1,"offset":260},"end":{"line":15,"column":51,"offset":310},"indent":[]}}],"position":{"start":{"line":12,"column":1,"offset":180},"end":{"line":15,"column":51,"offset":310},"indent":[1,1,1]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"questions","position":{"start":{"line":17,"column":5,"offset":316},"end":{"line":17,"column":14,"offset":325},"indent":[]}}],"position":{"start":{"line":17,"column":1,"offset":312},"end":{"line":17,"column":14,"offset":325},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"Say if we were to compute everything sequentially, it takes time ","position":{"start":{"line":19,"column":1,"offset":327},"end":{"line":19,"column":66,"offset":392},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">t</code>","position":{"start":{"line":19,"column":66,"offset":392},"end":{"line":19,"column":73,"offset":399},"indent":[]}},{"type":"text","value":" to finish.","position":{"start":{"line":19,"column":73,"offset":399},"end":{"line":19,"column":84,"offset":410},"indent":[]}}],"position":{"start":{"line":19,"column":1,"offset":327},"end":{"line":19,"column":84,"offset":410},"indent":[]}},{"type":"heading","depth":4,"children":[{"type":"text","value":"scenario 1","position":{"start":{"line":21,"column":6,"offset":417},"end":{"line":21,"column":16,"offset":427},"indent":[]}}],"position":{"start":{"line":21,"column":1,"offset":412},"end":{"line":21,"column":16,"offset":427},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"Assume that 256 threads are enough to keep all SPs in the SM busy all the time. What is the amount of time it’d take to perform the computation for ","position":{"start":{"line":23,"column":1,"offset":429},"end":{"line":23,"column":149,"offset":577},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"one block of 1024","position":{"start":{"line":23,"column":151,"offset":579},"end":{"line":23,"column":168,"offset":596},"indent":[]}}],"position":{"start":{"line":23,"column":149,"offset":577},"end":{"line":23,"column":170,"offset":598},"indent":[]}},{"type":"text","value":" threads? ","position":{"start":{"line":23,"column":170,"offset":598},"end":{"line":23,"column":180,"offset":608},"indent":[]}}],"position":{"start":{"line":23,"column":1,"offset":429},"end":{"line":23,"column":180,"offset":608},"indent":[]}},{"type":"heading","depth":4,"children":[{"type":"text","value":"scenario 2","position":{"start":{"line":25,"column":6,"offset":615},"end":{"line":25,"column":16,"offset":625},"indent":[]}}],"position":{"start":{"line":25,"column":1,"offset":610},"end":{"line":25,"column":16,"offset":625},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"What if we use ","position":{"start":{"line":27,"column":1,"offset":627},"end":{"line":27,"column":16,"offset":642},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"two blocks","position":{"start":{"line":27,"column":18,"offset":644},"end":{"line":27,"column":28,"offset":654},"indent":[]}}],"position":{"start":{"line":27,"column":16,"offset":642},"end":{"line":27,"column":30,"offset":656},"indent":[]}},{"type":"text","value":" of ","position":{"start":{"line":27,"column":30,"offset":656},"end":{"line":27,"column":34,"offset":660},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"512 threads","position":{"start":{"line":27,"column":36,"offset":662},"end":{"line":27,"column":47,"offset":673},"indent":[]}}],"position":{"start":{"line":27,"column":34,"offset":660},"end":{"line":27,"column":49,"offset":675},"indent":[]}},{"type":"text","value":" each?","position":{"start":{"line":27,"column":49,"offset":675},"end":{"line":27,"column":55,"offset":681},"indent":[]}}],"position":{"start":{"line":27,"column":1,"offset":627},"end":{"line":27,"column":55,"offset":681},"indent":[]}},{"type":"heading","depth":2,"children":[{"type":"text","value":"CUDA Resource Assignment","position":{"start":{"line":29,"column":4,"offset":686},"end":{"line":29,"column":28,"offset":710},"indent":[]}}],"position":{"start":{"line":29,"column":1,"offset":683},"end":{"line":29,"column":28,"offset":710},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"In order to see how the two scenarios differ, I thougth it was necessary to take another look at how resources are assigned to blocks and warps.","position":{"start":{"line":31,"column":1,"offset":712},"end":{"line":31,"column":145,"offset":856},"indent":[]}}],"position":{"start":{"line":31,"column":1,"offset":712},"end":{"line":31,"column":145,"offset":856},"indent":[]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"sequence of events","position":{"start":{"line":33,"column":5,"offset":862},"end":{"line":33,"column":23,"offset":880},"indent":[]}}],"position":{"start":{"line":33,"column":1,"offset":858},"end":{"line":33,"column":23,"offset":880},"indent":[]}},{"type":"list","ordered":true,"start":1,"spread":true,"children":[{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"kernel launch","position":{"start":{"line":35,"column":4,"offset":885},"end":{"line":35,"column":17,"offset":898},"indent":[]}}],"position":{"start":{"line":35,"column":4,"offset":885},"end":{"line":35,"column":17,"offset":898},"indent":[]}}],"position":{"start":{"line":35,"column":1,"offset":882},"end":{"line":36,"column":1,"offset":899},"indent":[1]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"CUDA runtime generates the corresponding grid of threads.","position":{"start":{"line":37,"column":4,"offset":903},"end":{"line":37,"column":61,"offset":960},"indent":[]}}],"position":{"start":{"line":37,"column":4,"offset":903},"end":{"line":37,"column":61,"offset":960},"indent":[]}}],"position":{"start":{"line":37,"column":1,"offset":900},"end":{"line":38,"column":1,"offset":961},"indent":[1]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"threads are assigned to execution resources on a block-to-block basis.","position":{"start":{"line":39,"column":4,"offset":965},"end":{"line":39,"column":74,"offset":1035},"indent":[]}}],"position":{"start":{"line":39,"column":4,"offset":965},"end":{"line":39,"column":74,"offset":1035},"indent":[]}}],"position":{"start":{"line":39,"column":1,"offset":962},"end":{"line":39,"column":74,"offset":1035},"indent":[]}}],"position":{"start":{"line":35,"column":1,"offset":882},"end":{"line":39,"column":74,"offset":1035},"indent":[1,1,1,1]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"blocks and SMs","position":{"start":{"line":41,"column":5,"offset":1041},"end":{"line":41,"column":19,"offset":1055},"indent":[]}}],"position":{"start":{"line":41,"column":1,"offset":1037},"end":{"line":41,"column":19,"offset":1055},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"Multiple blocks can be assigned to each SM. But each device sets a limit on the number of blocks that can be assigned to each SM.","position":{"start":{"line":43,"column":1,"offset":1057},"end":{"line":43,"column":130,"offset":1186},"indent":[]}}],"position":{"start":{"line":43,"column":1,"offset":1057},"end":{"line":43,"column":130,"offset":1186},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"Say that a device allows 8 blocks to be assigned to each SM. In situations where there’s a ","position":{"start":{"line":45,"column":1,"offset":1188},"end":{"line":45,"column":92,"offset":1279},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"shortage of one or more types of resources","position":{"start":{"line":45,"column":94,"offset":1281},"end":{"line":45,"column":136,"offset":1323},"indent":[]}}],"position":{"start":{"line":45,"column":92,"offset":1279},"end":{"line":45,"column":138,"offset":1325},"indent":[]}},{"type":"text","value":" needed for the simultaneous execution of 8 blocks, the CUDA runtime automatically reduces the number of blocks assigned to each SM until their combined resource usage falls below the limit.","position":{"start":{"line":45,"column":138,"offset":1325},"end":{"line":45,"column":328,"offset":1515},"indent":[]}}],"position":{"start":{"line":45,"column":1,"offset":1188},"end":{"line":45,"column":328,"offset":1515},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"The runtime system:","position":{"start":{"line":47,"column":1,"offset":1517},"end":{"line":47,"column":20,"offset":1536},"indent":[]}}],"position":{"start":{"line":47,"column":1,"offset":1517},"end":{"line":47,"column":20,"offset":1536},"indent":[]}},{"type":"list","ordered":false,"start":null,"spread":true,"children":[{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"maintains a list of blocks that need to execute","position":{"start":{"line":49,"column":3,"offset":1540},"end":{"line":49,"column":50,"offset":1587},"indent":[]}}],"position":{"start":{"line":49,"column":3,"offset":1540},"end":{"line":49,"column":50,"offset":1587},"indent":[]}}],"position":{"start":{"line":49,"column":1,"offset":1538},"end":{"line":50,"column":1,"offset":1588},"indent":[1]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"assigns new block to SMs as previously assigned blocks complete execution.","position":{"start":{"line":51,"column":3,"offset":1591},"end":{"line":51,"column":77,"offset":1665},"indent":[]}}],"position":{"start":{"line":51,"column":3,"offset":1591},"end":{"line":51,"column":77,"offset":1665},"indent":[]}}],"position":{"start":{"line":51,"column":1,"offset":1589},"end":{"line":51,"column":77,"offset":1665},"indent":[]}}],"position":{"start":{"line":49,"column":1,"offset":1538},"end":{"line":51,"column":77,"offset":1665},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"html","title":null,"url":"./blocks.jpg","alt":"blocks to SM","position":{"start":{"line":53,"column":1,"offset":1667},"end":{"line":53,"column":30,"offset":1696},"indent":[]},"value":"<figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 542px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/50d63938ab66988aafbd2dafbf4bfd02/36b00/blocks.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.992619926199254%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAIEAwX/xAAWAQEBAQAAAAAAAAAAAAAAAAABAAL/2gAMAwEAAhADEAAAAeslc+ZzYX//xAAaEAEBAAIDAAAAAAAAAAAAAAABAgADESEi/9oACAEBAAEFAvQzbWSPD2RrJrP/xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAwEBPwFX/8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQIBAT8BiP/EABsQAAIBBQAAAAAAAAAAAAAAAAABERAhMVFh/9oACAEBAAY/AnojhcZMvFP/xAAcEAADAAEFAAAAAAAAAAAAAAAAAREhEDFBUYH/2gAIAQEAAT8hd17FgdepH5ixdoUkZIzp/9oADAMBAAIAAwAAABDYz//EABYRAQEBAAAAAAAAAAAAAAAAAAEAEf/aAAgBAwEBPxBVdtX/xAAXEQADAQAAAAAAAAAAAAAAAAAAARFB/9oACAECAQE/ELxkH//EABsQAQACAwEBAAAAAAAAAAAAAAEAMREhURBB/9oACAEBAAE/EAlXMOxUNLg23mVZ38hqqCGS44H0WJd1fn//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"blocks to SM\"\n        title=\"blocks to SM\"\n        src=\"/static/50d63938ab66988aafbd2dafbf4bfd02/36b00/blocks.jpg\"\n        srcset=\"/static/50d63938ab66988aafbd2dafbf4bfd02/7237a/blocks.jpg 148w,\n/static/50d63938ab66988aafbd2dafbf4bfd02/0cfdf/blocks.jpg 295w,\n/static/50d63938ab66988aafbd2dafbf4bfd02/36b00/blocks.jpg 542w\"\n        sizes=\"(max-width: 542px) 100vw, 542px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">blocks to SM</figcaption>\n  </figure>"}],"position":{"start":{"line":53,"column":1,"offset":1667},"end":{"line":53,"column":30,"offset":1696},"indent":[]}},{"type":"heading","depth":2,"children":[{"type":"text","value":"Puzzle Solution","position":{"start":{"line":55,"column":4,"offset":1701},"end":{"line":55,"column":19,"offset":1716},"indent":[]}}],"position":{"start":{"line":55,"column":1,"offset":1698},"end":{"line":55,"column":19,"offset":1716},"indent":[]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"scenario 1","position":{"start":{"line":57,"column":5,"offset":1722},"end":{"line":57,"column":15,"offset":1732},"indent":[]}}],"position":{"start":{"line":57,"column":1,"offset":1718},"end":{"line":57,"column":15,"offset":1732},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"First, a block is assigned to ","position":{"start":{"line":59,"column":1,"offset":1734},"end":{"line":59,"column":31,"offset":1764},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"one","position":{"start":{"line":59,"column":33,"offset":1766},"end":{"line":59,"column":36,"offset":1769},"indent":[]}}],"position":{"start":{"line":59,"column":31,"offset":1764},"end":{"line":59,"column":38,"offset":1771},"indent":[]}},{"type":"text","value":" SM, not more.","position":{"start":{"line":59,"column":38,"offset":1771},"end":{"line":59,"column":52,"offset":1785},"indent":[]}}],"position":{"start":{"line":59,"column":1,"offset":1734},"end":{"line":59,"column":52,"offset":1785},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"Even though there are 1024 threads in the block, the number of ","position":{"start":{"line":61,"column":1,"offset":1787},"end":{"line":61,"column":64,"offset":1850},"indent":[]}}],"position":{"start":{"line":61,"column":1,"offset":1787},"end":{"line":61,"column":64,"offset":1850},"indent":[]}}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":61,"column":64,"offset":1850}}}}